name: Build and Push Docker image to DOCR

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  metadata:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      cache-key: ${{ steps.meta.outputs.cache-key }}
    steps:
      - name: Prepare image metadata
        id: meta
        run: |
          echo "tag=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          echo "cache-key=docker-${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

  build:
    runs-on: ubuntu-latest
    needs: metadata
    permissions:
      contents: read
    env:
      REGISTRY: registry.digitalocean.com/${{ secrets.DOCR_REGISTRY }}
      IMAGE: ${{ secrets.IMAGE_NAME }}
      TAG: ${{ needs.metadata.outputs.tag }}
      REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || secrets.REACT_APP_API_URL }}
      NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ needs.metadata.outputs.cache-key }}

      - name: Prepare build environment
        run: |
          if [[ -z "${REACT_APP_API_URL}" ]]; then
            echo "REACT_APP_API_URL secret must be set to bake API URLs into the frontend build." >&2
            exit 1
          fi

      - name: Build image
        run: |
          build_args=(
            --tag "$REGISTRY/$IMAGE:$TAG"
            --tag "$REGISTRY/$IMAGE:latest"
            --load
            --cache-from "type=local,src=/tmp/.buildx-cache"
            --cache-to "type=local,dest=/tmp/.buildx-cache-new"
            --build-arg "REACT_APP_API_URL=${REACT_APP_API_URL}"
            --build-arg "NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}"
          )
          if [[ -n "${NEXT_PUBLIC_SITE_URL}" ]]; then
            build_args+=(--build-arg "NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}")
          fi
          docker buildx build "${build_args[@]}" .

      - name: Move build cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Save image as artifact
        run: |
          mkdir -p /tmp/images
          docker save $REGISTRY/$IMAGE:$TAG $REGISTRY/$IMAGE:latest | gzip > /tmp/images/image.tar.gz
      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/images/image.tar.gz

  push:
    runs-on: ubuntu-latest
    needs: [metadata, build]
    permissions:
      contents: read
    env:
      REGISTRY: registry.digitalocean.com/${{ secrets.DOCR_REGISTRY }}
      IMAGE: ${{ secrets.IMAGE_NAME }}
      TAG: ${{ needs.metadata.outputs.tag }}
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login to DO Container Registry
        run: doctl registry login --expiry-seconds 600

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp/images

      - name: Load and push image
        run: |
          zcat /tmp/images/image.tar.gz | docker load
          docker tag $REGISTRY/$IMAGE:$TAG $REGISTRY/$IMAGE:latest
          docker push $REGISTRY/$IMAGE:$TAG
          docker push $REGISTRY/$IMAGE:latest
