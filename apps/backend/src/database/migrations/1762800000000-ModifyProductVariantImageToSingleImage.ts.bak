import { MigrationInterface, QueryRunner } from 'typeorm';

export class ModifyProductVariantImageToSingleImage1762800000000 implements MigrationInterface {
    public async up(queryRunner: QueryRunner): Promise<void> {
        // First, create a temporary column to store the single image
        await queryRunner.query(`
            ALTER TABLE "product_variants"
            ADD COLUMN "image" character varying(500)
        `);

        // Migrate existing data: extract the first image from the JSON array
        await queryRunner.query(`
            UPDATE "product_variants"
            SET "image" = (
                CASE
                    WHEN "images" IS NOT NULL AND "images" != '' AND "images" != '[]' THEN
                        CASE
                            WHEN json_array_length("images"::json) > 0 THEN
                                ("images"::json->>0)
                            ELSE NULL
                        END
                    ELSE NULL
                END
            )
            WHERE "images" IS NOT NULL
        `);

        // Drop the old images column
        await queryRunner.query(`
            ALTER TABLE "product_variants"
            DROP COLUMN "images"
        `);

        // Add index for better performance when querying by image
        await queryRunner.query(`
            CREATE INDEX "IDX_product_variants_image" ON "product_variants" ("image")
        `);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        // Drop the index first
        await queryRunner.query(`DROP INDEX "IDX_product_variants_image"`);

        // Add back the images column as text
        await queryRunner.query(`
            ALTER TABLE "product_variants"
            ADD COLUMN "images" text
        `);

        // Migrate data back: convert single image to JSON array
        await queryRunner.query(`
            UPDATE "product_variants"
            SET "images" = (
                CASE
                    WHEN "image" IS NOT NULL AND "image" != '' THEN
                        json_build_array("image")::text
                    ELSE NULL
                END
            )
            WHERE "image" IS NOT NULL
        `);

        // Drop the image column
        await queryRunner.query(`
            ALTER TABLE "product_variants"
            DROP COLUMN "image"
        `);
    }
}