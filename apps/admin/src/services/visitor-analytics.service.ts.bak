import { trpc } from '../utils/trpc';

export interface VisitorAnalyticsResponse {
  visitors: {
    totalVisitors: number;
    newVisitors: number;
    returningVisitors: number;
    visitorsBySource: Array<{
      source: string;
      count: number;
      percentage: number;
    }>;
  };
  sessions: {
    totalSessions: number;
    avgDuration: number;
    avgPageViews: number;
    bounceRate: number;
  };
  pageViews: {
    totalPageViews: number;
    pageViewsByType: Array<{
      type: string;
      count: number;
      percentage: number;
    }>;
  };
  realTime: {
    visitors: number;
    sessions: number;
    pageViews: number;
    activeSessions: number;
  };
  trends: {
    daily: Array<{
      date: string;
      visitors: number;
      sessions: number;
      pageViews: number;
    }>;
    weekly: Array<{
      week: string;
      visitors: number;
      sessions: number;
      pageViews: number;
    }>;
  };
  topPages: Array<{
    url: string;
    title: string;
    uniqueViews: number;
    totalViews: number;
  }>;
  devices: {
    deviceTypes: Array<{
      type: string;
      count: number;
      percentage: number;
    }>;
    browsers: Array<{
      name: string;
      count: number;
      percentage: number;
    }>;
    operatingSystems: Array<{
      name: string;
      count: number;
      percentage: number;
    }>;
  };
  geographic: {
    topCountries: Array<{
      country: string;
      count: number;
      percentage: number;
    }>;
    topCities: Array<{
      city: string;
      count: number;
      percentage: number;
    }>;
  };
}

class VisitorAnalyticsService {
  async getStatistics(startDate: Date, endDate: Date): Promise<VisitorAnalyticsResponse> {
    const days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24));

    try {
      // Fetch all data in parallel for better performance
      const [
        overallStats,
        dailyTrends,
        weeklyTrends,
        topPages,
        pageViewStatsByType,
        visitorStatsBySource,
        realTimeStats,
        geographicStats,
        deviceStats,
        conversionStats,
        trafficSources
      ] = await Promise.all([
        trpc.adminVisitorStatistics.getOverallStats.query({ days }),
        trpc.adminVisitorStatistics.getDailyTrends.query({ days }),
        trpc.adminVisitorStatistics.getWeeklyTrends.query({ weeks: Math.min(12, Math.ceil(days / 7)) }),
        trpc.adminVisitorStatistics.getTopPages.query({ limit: 10, days }),
        trpc.adminVisitorStatistics.getPageViewStatsByType.query({ days }),
        trpc.adminVisitorStatistics.getVisitorStatsBySource.query({ days }),
        trpc.adminVisitorStatistics.getRealTimeStats.query(),
        trpc.adminVisitorStatistics.getGeographicStats.query({ days }),
        trpc.adminVisitorStatistics.getDeviceStats.query({ days }),
        trpc.adminVisitorStatistics.getConversionStats.query({ days }),
        trpc.adminVisitorStatistics.getTrafficSources.query({ days })
      ]);

      // Combine all the data into the expected format
      return {
        visitors: {
          totalVisitors: overallStats.visitors.totalVisitors,
          newVisitors: overallStats.visitors.newVisitors,
          returningVisitors: overallStats.visitors.returningVisitors,
          visitorsBySource: visitorStatsBySource.data.map((source: any) => ({
            source: source.source,
            count: source.count,
            percentage: source.percentage
          }))
        },
        sessions: {
          totalSessions: overallStats.sessions.totalSessions,
          avgDuration: overallStats.sessions.avgDuration,
          avgPageViews: overallStats.sessions.avgPageViews,
          bounceRate: overallStats.sessions.bounceRate
        },
        pageViews: {
          totalPageViews: overallStats.pageViews.totalPageViews,
          pageViewsByType: pageViewStatsByType.data.map((type: any) => ({
            type: type.type,
            count: type.count,
            percentage: type.percentage
          }))
        },
        realTime: {
          visitors: realTimeStats.data.today.visitors,
          sessions: realTimeStats.data.today.sessions,
          pageViews: realTimeStats.data.today.pageViews,
          activeSessions: realTimeStats.data.today.activeSessions
        },
        trends: {
          daily: dailyTrends.data.map((trend: any) => ({
            date: trend.date,
            visitors: trend.visitors,
            sessions: trend.sessions,
            pageViews: trend.pageViews
          })),
          weekly: weeklyTrends.data.map((trend: any) => ({
            week: trend.week,
            visitors: trend.visitors,
            sessions: trend.sessions,
            pageViews: trend.pageViews
          }))
        },
        topPages: topPages.data.map((page: any) => ({
          url: page.url,
          title: page.title,
          uniqueViews: page.uniqueViews,
          totalViews: page.totalViews
        })),
        devices: {
          deviceTypes: deviceStats.data.deviceTypes.map((device: any) => ({
            type: device.type,
            count: device.count,
            percentage: device.percentage
          })),
          browsers: deviceStats.data.browsers.map((browser: any) => ({
            name: browser.name,
            count: browser.count,
            percentage: browser.percentage
          })),
          operatingSystems: deviceStats.data.operatingSystems.map((os: any) => ({
            name: os.name,
            count: os.count,
            percentage: os.percentage
          }))
        },
        geographic: {
          topCountries: geographicStats.data.topCountries.map((country: any) => ({
            country: country.country,
            count: country.count,
            percentage: country.percentage
          })),
          topCities: geographicStats.data.topCities.map((city: any) => ({
            city: city.city,
            count: city.count,
            percentage: city.percentage
          }))
        }
      };
    } catch (error) {
      console.error('Failed to fetch visitor analytics:', error);
      throw new Error('Failed to load visitor analytics data');
    }
  }

  async getRealTimeStats() {
    try {
      return await trpc.adminVisitorStatistics.getRealTimeStats.query();
    } catch (error) {
      console.error('Failed to fetch real-time stats:', error);
      throw new Error('Failed to load real-time statistics');
    }
  }

  async getTopPages(limit: number = 10, days: number = 30) {
    try {
      return await trpc.adminVisitorStatistics.getTopPages.query({ limit, days });
    } catch (error) {
      console.error('Failed to fetch top pages:', error);
      throw new Error('Failed to load top pages data');
    }
  }

  async getDeviceStats(days: number = 30) {
    try {
      return await trpc.adminVisitorStatistics.getDeviceStats.query({ days });
    } catch (error) {
      console.error('Failed to fetch device stats:', error);
      throw new Error('Failed to load device statistics');
    }
  }

  async getGeographicStats(days: number = 30) {
    try {
      return await trpc.adminVisitorStatistics.getGeographicStats.query({ days });
    } catch (error) {
      console.error('Failed to fetch geographic stats:', error);
      throw new Error('Failed to load geographic statistics');
    }
  }

  async getConversionStats(days: number = 30) {
    try {
      return await trpc.adminVisitorStatistics.getConversionStats.query({ days });
    } catch (error) {
      console.error('Failed to fetch conversion stats:', error);
      throw new Error('Failed to load conversion statistics');
    }
  }
}

// Export singleton instance
export const visitorAnalyticsService = new VisitorAnalyticsService();